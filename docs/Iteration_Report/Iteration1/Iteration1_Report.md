# Interation 1 : The ECTD, Triple genration, and GraphJudge phases of the output data

- First Draft
- Writing date : 2025/8/7

## ECTD

### Code

- `run_entity.py`: Miscellaneous\KgGen\GraphJudge\chat\run_entity.py

### Output data

- `test_entity.txt`:
  Miscellaneous\KgGen\GraphJudge\datasets\KIMI_result_DreamOf_RedChamber\Grapg_Iteration1\test_entity.txt
- `test_denoised.target`:     
  Miscellaneous\KgGen\GraphJudge\datasets\KIMI_result_DreamOf_RedChamber\Grapg_Iteration1\test_denoised.target

### Ouptut Data Quality Summary

In the test_entity.txt file, each line lists relevant names, places, objects, or abstract concepts from the first chapter of "紅樓夢" in Python list format, totaling thirty-three entries. Overall, the key entities cover a wide range, from main characters (such as "甄士隱" and "賈雨村") to locations (such as "大荒山" and "北邙山"), and even extend to abstract terms (such as "功名" and "家庭"), which can fully support subsequent graph node construction and relationship reasoning. The data is mostly in traditional Chinese, with consistent punctuation and parentheses usage, indicating that basic cleaning has been completed, facilitating direct parsing by the program.

The test_denoised.target file contains denoised narrative sentences that preserve the plot of the same chapter, totaling thirty-three segments, each corresponding to the entities listed above. The narrative context is clear and the sequence is logical. The content not only covers major events (such as the補天石, the wish of 警幻仙子, and the fire at 甄家) but also retains causal relationships and character psychological descriptions, which are helpful for downstream generation of "event triplets" or training narrative-based large models. The overall sentences use full-width punctuation and standard traditional Chinese, with a low error rate, indicating good quality of text denoising.

However, there are still areas for improvement in both ECTD data:
1) In test_entity.txt, there are occasional duplicate terms within individual entries (for example, "神瑛侍者" appears twice) and category terms (such as "功名" and "朝代") mixed in, which may interfere with entity uniqueness and type annotation;
2) In test_denoised.target, some lines are excessively long and have inconsistent spacing, which can easily cause sentence or word segmentation errors;
3) An empty last line may lead to read errors. It is recommended to subsequently review the data with automatic deduplication, type filtering, and format validation (ensuring line endings and uniform full-width spaces), and to include corresponding entity-narrative alignment checks to enhance the accuracy and robustness of knowledge graph extraction.

### Terminal Running Progress

- Lack of result data.
- Kind of slow. Because of KIMI-K2 Free User limit LLM calling freqency within 3 RPM, the speed is limited.


---

## Triple Generation

### code

- `run_kimi_triple.py`: Miscellaneous\KgGen\GraphJudge\chat\run_kimi_triple.py

### Output data

- orginal triple generated data `test_generated_graphs.txt`:    
  Miscellaneous\KgGen\GraphJudge\datasets\KIMI_result_DreamOf_RedChamber\Graph_Iteration1\test_generated_graphs.txt
- Cursor AI convert the `test_generated_graphs.txt` into GraphJude code `run_kimi_gj.py` needs data format. Below two datas are generated by Cursor AI LLM(Claude 4.0 Sonnet Thinking) according to `test_generated_graphs.txt`.
  - `test_statements_for_graph_judge.txt`: First edition that convert into the direct spelling according to `test_generated_graphs.txt`: Miscellaneous\KgGen\GraphJudge\datasets\KIMI_result_DreamOf_RedChamber\Graph_Iteration1\test_statements_for_graph_judge.txt
  - `test_instructions_context_kimi.json` : The formal json data need to input to the `run_kimi_gj.py`, to run the Graph Judge phase.However, it skipped a lot of content from  `test_statements_for_graph_judge.txt`:   Miscellaneous\KgGen\GraphJudge\datasets\KIMI_result_DreamOf_RedChamber\Graph_Iteration1\test_instructions_context_kimi.json

### Output Data Quality Summary

`test_generated_graphs.txt` describes the blocks of triples wrapped in natural language, with each line prefixed by descriptions such as "according to the text content" followed by a JSON-like list in brackets. While it retains rich semantics and relationship types, it contains mixed Chinese descriptions, inconsistent punctuation, and mixed English and Chinese property names, which necessitates prior normalization for programmatic parsing. Additionally, some triples are duplicated or have varying granularity in property vocabulary, which can lead to redundancy in nodes/edges.

`test_statements_for_graph_judge.txt` has been purified by Cursor AI into a "subject space predicate space object" format, removing unnecessary descriptions and significantly enhancing machine readability. The data is overall complete, and the number of lines corresponds to the original generated content; however, a small number of duplicate triples and interspersed synonymous property terms (such as "location" and "place") remain. It is recommended to subsequently unify relationship labels through deduplication and a property mapping table to avoid scattered statistics during evaluation.

`test_instructions_context_kimi.json` has been further transformed into the JSON array required by Graph Judge, with each element containing a validation instruction `instruction`. This version has a rigorous format that is easy for automated batch evaluation, but due to capacity limitations, some triples have been omitted (approximately a 40% reduction), resulting in decreased sample coverage. Additionally, the `output` fields are all left blank, requiring dynamic completion of answers during the evaluation phase. It is suggested to retain all triples using batch splitting or compression strategies, while also pre-filling expected answer placeholders to facilitate accuracy statistics.

### Terminal Running Progress

- Lack of result data.
- Kind of slow. Because of KIMI-K2 Free User limit LLM calling freqency within 3 RPM, the speed is limited.

---

## Graph Judge

### Code

- `run_kimi_gj.py` : Miscellaneous\KgGen\GraphJudge\chat\run_kimi_gj.py

### Processing Effiency

- Processing Time: 11:42
- Because of KIMI-K2 Free User limit LLM calling freqency within 3 RPM, the speed is limited.

### Output Data 

- `pred_instructions_context_kimi_itr1.csv` : Miscellaneous\KgGen\GraphJudge\datasets\KIMI_result_DreamOf_RedChamber\Graph_Iteration1\pred_instructions_context_kimi_itr1.csv

### Output Data Quality Summary

`test_instructions_context_kimi.json` provides 153 neatly formatted yes/no prompts such as `Is this true: 作者 創作 石頭記 ?`.  The questions follow a consistent "Is this true:" prefix and preserve the full triple text, making them easy for automatic judgement loops.  Nonetheless, roughly 40 % of the original triples were dropped during the conversion, and some Chinese punctuation remains (e.g., the full-width question mark at the end), which could confuse purely ASCII parsers.

`pred_instructions_context_kimi_itr1.csv` stores model verdicts with two columns (`prompt`, `generated`).  Quality is uneven: only 2 of the first 17 author-related facts receive a "Yes" (see rows 2 and 19 below), while most obviously correct statements are marked "No".  Example excerpt:
```
Is this true: 作者 創作 石頭記 ?,Yes, it is true.
Is this true: 作者 經歷 夢幻 ?,No, it is not true.
Is this true: 女媧氏 行為 煉石補天 ?,Yes, it is true.
```
The contradictory answers indicate either prompt mis-parsing or a weak checkpoint.

Taken together, the judgement phase currently suffers from (1) reduced coverage, (2) high false-negative bias, and (3) absent ground-truth labels for direct accuracy calculation.  We recommend re-generating the instruction list in smaller chunks to keep 100 % coverage, adding a gold `expected` column for later scoring, and inserting rule-based sanity checks (e.g., flag cases where every triple inside the same semantic cluster is predicted "No").

### Terminal Running Progress

(.venv) D:\AboutUniversity\114 NSTC_and_SeniorProject\2025-IM-senior-project\Miscellaneous\KgGen\GraphJudge\chat>python run_kimi_gj.py
✓ Moonshot API key loaded successfully
=== KIMI-K2 API Configuration ===
RPM Limit: 3
Concurrent Requests: 1
Retry Attempts: 5
Base Delay: 20s
Calculated Delay: 20s
Temperature: 0.1
Max Tokens: 1000
Model: moonshot/kimi-k2-0711-preview
===================================
✓ Dataset loaded: 30 total samples
✓ Using all 30 samples for evaluation (small dataset)
📊 Final evaluation dataset size: 30 instructions
✓ Loaded 30 instruction entries
============================================================
🎯 KIMI-K2 Graph Judge - Knowledge Graph Triple Validation
============================================================
🔍 Running pre-flight checks...
✓ Input file validation passed: 30 entries
🚀 Starting KIMI-K2 Graph Judge processing...
📊 Processing 30 graph judgment tasks...
📊 Configuration: Max concurrent requests = 1, RPM limit = 3
⏱️  Estimated delay between requests: 20.00 seconds
------------------------------------------------------------
Processing with KIMI-K2:   0%|                              | 0/30 [00:00<?, ?it/s] 🔄 Processing instruction 9/30 (Delay: 20.00s)
✅ Completed instruction 9/30
Processing with KIMI-K2:   3%|▋                     | 1/30 [00:22<11:01, 22.80s/it] 🔄 Processing instruction 19/30 (Delay: 20.00s)
✅ Completed instruction 19/30
Processing with KIMI-K2:   7%|█▍                    | 2/30 [00:44<10:20, 22.15s/it] 🔄 Processing instruction 29/30 (Delay: 20.00s)
✅ Completed instruction 29/30
Processing with KIMI-K2:  10%|██▏                   | 3/30 [01:14<11:30, 25.58s/it] 🔄 Processing instruction 10/30 (Delay: 20.00s)
✅ Completed instruction 10/30
Processing with KIMI-K2:  13%|██▉                   | 4/30 [01:36<10:30, 24.25s/it] 🔄 Processing instruction 20/30 (Delay: 20.00s)
✅ Completed instruction 20/30
Processing with KIMI-K2:  17%|███▋                  | 5/30 [01:58<09:47, 23.49s/it] 🔄 Processing instruction 30/30 (Delay: 20.00s)
✅ Completed instruction 30/30
Processing with KIMI-K2:  20%|████▍                 | 6/30 [02:20<09:12, 23.04s/it] 🔄 Processing instruction 11/30 (Delay: 20.00s)
✅ Completed instruction 11/30
Processing with KIMI-K2:  23%|█████▏                | 7/30 [02:42<08:43, 22.74s/it] 🔄 Processing instruction 2/30 (Delay: 20.00s)
✅ Completed instruction 2/30
Processing with KIMI-K2:  27%|█████▊                | 8/30 [03:05<08:21, 22.79s/it] 🔄 Processing instruction 21/30 (Delay: 20.00s)
✅ Completed instruction 21/30
Processing with KIMI-K2:  30%|██████▌               | 9/30 [03:27<07:51, 22.44s/it] 🔄 Processing instruction 12/30 (Delay: 20.00s)
✅ Completed instruction 12/30
Processing with KIMI-K2:  33%|███████              | 10/30 [03:49<07:25, 22.29s/it] 🔄 Processing instruction 3/30 (Delay: 20.00s)
✅ Completed instruction 3/30
Processing with KIMI-K2:  37%|███████▋             | 11/30 [04:11<07:03, 22.27s/it] 🔄 Processing instruction 22/30 (Delay: 20.00s)
✅ Completed instruction 22/30
Processing with KIMI-K2:  40%|████████▍            | 12/30 [04:33<06:39, 22.18s/it] 🔄 Processing instruction 13/30 (Delay: 20.00s)
✅ Completed instruction 13/30
Processing with KIMI-K2:  43%|█████████            | 13/30 [04:55<06:15, 22.09s/it] 🔄 Processing instruction 4/30 (Delay: 20.00s)
✅ Completed instruction 4/30
Processing with KIMI-K2:  47%|█████████▊           | 14/30 [05:17<05:53, 22.08s/it] 🔄 Processing instruction 23/30 (Delay: 20.00s)
✅ Completed instruction 23/30
Processing with KIMI-K2:  50%|██████████▌          | 15/30 [05:39<05:30, 22.02s/it] 🔄 Processing instruction 14/30 (Delay: 20.00s)
✅ Completed instruction 14/30
Processing with KIMI-K2:  53%|███████████▏         | 16/30 [06:01<05:09, 22.11s/it] 🔄 Processing instruction 5/30 (Delay: 20.00s)
✅ Completed instruction 5/30
Processing with KIMI-K2:  57%|███████████▉         | 17/30 [06:23<04:47, 22.09s/it] 🔄 Processing instruction 24/30 (Delay: 20.00s)
✅ Completed instruction 24/30
Processing with KIMI-K2:  50%|██████████▌          | 15/30 [05:39<05:30, 22.02s/it] 🔄 Processing instruction 14/30 (Delay: 20.00s)
✅ Completed instruction 14/30
Processing with KIMI-K2:  53%|███████████▏         | 16/30 [06:01<05:09, 22.11s/it] 🔄 Processing instruction 5/30 (Delay: 20.00s)
✅ Completed instruction 5/30
Processing with KIMI-K2:  57%|███████████▉         | 17/30 [06:23<04:47, 22.09s/it] 🔄 Processing instruction 24/30 (Delay: 20.00s)
✅ Completed instruction 24/30
✅ Completed instruction 14/30
Processing with KIMI-K2:  53%|███████████▏         | 16/30 [06:01<05:09, 22.11s/it] 🔄 Processing instruction 5/30 (Delay: 20.00s)
✅ Completed instruction 5/30
Processing with KIMI-K2:  57%|███████████▉         | 17/30 [06:23<04:47, 22.09s/it] 🔄 Processing instruction 24/30 (Delay: 20.00s)
✅ Completed instruction 24/30
🔄 Processing instruction 5/30 (Delay: 20.00s)
✅ Completed instruction 5/30
Processing with KIMI-K2:  57%|███████████▉         | 17/30 [06:23<04:47, 22.09s/it] 🔄 Processing instruction 24/30 (Delay: 20.00s)
✅ Completed instruction 24/30
Processing with KIMI-K2:  57%|███████████▉         | 17/30 [06:23<04:47, 22.09s/it] 🔄 Processing instruction 24/30 (Delay: 20.00s)
✅ Completed instruction 24/30
🔄 Processing instruction 24/30 (Delay: 20.00s)
✅ Completed instruction 24/30
✅ Completed instruction 24/30
Processing with KIMI-K2:  60%|████████████▌        | 18/30 [06:45<04:25, 22.09s/it] 🔄 Processing instruction 15/30 (Delay: 20.00s)
✅ Completed instruction 15/30
Processing with KIMI-K2:  63%|█████████████▎       | 19/30 [07:07<04:02, 22.06s/it] 🔄 Processing instruction 6/30 (Delay: 20.00s)
✅ Completed instruction 6/30
Processing with KIMI-K2:  67%|██████████████       | 20/30 [07:29<03:40, 22.02s/it] 🔄 Processing instruction 25/30 (Delay: 20.00s)
✅ Completed instruction 25/30
Processing with KIMI-K2:  70%|██████████████▋      | 21/30 [07:51<03:18, 22.06s/it] 🔄 Processing instruction 16/30 (Delay: 20.00s)
✅ Completed instruction 16/30
Processing with KIMI-K2:  73%|███████████████▍     | 22/30 [08:14<02:56, 22.10s/it] 🔄 Processing instruction 7/30 (Delay: 20.00s)
✅ Completed instruction 7/30
Processing with KIMI-K2:  77%|████████████████     | 23/30 [08:39<02:41, 23.05s/it] 🔄 Processing instruction 26/30 (Delay: 20.00s)
✅ Completed instruction 26/30
Processing with KIMI-K2:  80%|████████████████▊    | 24/30 [09:01<02:16, 22.67s/it] 🔄 Processing instruction 17/30 (Delay: 20.00s)
✅ Completed instruction 17/30
Processing with KIMI-K2:  83%|█████████████████▌   | 25/30 [09:23<01:52, 22.51s/it] 🔄 Processing instruction 8/30 (Delay: 20.00s)
✅ Completed instruction 8/30
Processing with KIMI-K2:  87%|██████████████████▏  | 26/30 [10:14<02:04, 31.14s/it] 🔄 Processing instruction 27/30 (Delay: 20.00s)
✅ Completed instruction 27/30
Processing with KIMI-K2:  90%|██████████████████▉  | 27/30 [10:37<01:26, 28.82s/it] 🔄 Processing instruction 1/30 (Delay: 20.00s)
✅ Completed instruction 1/30
Processing with KIMI-K2:  93%|███████████████████▌ | 28/30 [10:59<00:53, 26.69s/it] 🔄 Processing instruction 18/30 (Delay: 20.00s)
✅ Completed instruction 18/30
Processing with KIMI-K2:  97%|████████████████████▎| 29/30 [11:21<00:25, 25.16s/it] 🔄 Processing instruction 28/30 (Delay: 20.00s)
✅ Completed instruction 28/30
Processing with KIMI-K2: 100%|█████████████████████| 30/30 [11:42<00:00, 23.43s/it]
💾 Saving results to ../datasets/KIMI_result_DreamOf_RedChamber/Graph_Iteration1/pred_instructions_context_kimi_itr1.csv...
✅ Completed instruction 28/30
Processing with KIMI-K2: 100%|█████████████████████| 30/30 [11:42<00:00, 23.43s/it] 
💾 Saving results to ../datasets/KIMI_result_DreamOf_RedChamber/Graph_Iteration1/pred_instructions_context_kimi_itr1.csv...
✅ KIMI-K2 Graph Judge processing completed!
📊 Results saved to: ../datasets/KIMI_result_DreamOf_RedChamber/Graph_Iteration1/pred_instructions_context_kimi_itr1.csv
📈 Processing statistics:
   - Successful responses: 30
   - Error responses: 0
   - Success rate: 100.0%

🎉 Graph judgment pipeline completed successfully!
d_instructions_context_kimi_itr1.csv
📈 Processing statistics:
   - Successful responses: 30
   - Error responses: 0
   - Success rate: 100.0%

🎉 Graph judgment pipeline completed successfully!
📈 Processing statistics:
   - Successful responses: 30
   - Error responses: 0
   - Success rate: 100.0%

🎉 Graph judgment pipeline completed successfully!
   - Successful responses: 30
   - Error responses: 0
   - Success rate: 100.0%

🎉 Graph judgment pipeline completed successfully!
📂 Results available at: ../datasets/KIMI_result_DreamOf_RedChamber/Graph_Iteration1   - Success rate: 100.0%

🎉 Graph judgment pipeline completed successfully!
📂 Results available at: ../datasets/KIMI_result_DreamOf_RedChamber/Graph_Iteration1📂 Results available at: ../datasets/KIMI_result_DreamOf_RedChamber/Graph_Iteration1/pred_instructions_context_kimi_itr1.csv

---

- **And it won't produce the final kg after the Graph Judge phase.**
- **It's necessary to organize the pipeline combine the three phases. And improve the generated data quality of the three phases.**
- **Maybe the GraphJudge can use Perplexity for the graph judge --> Use internet resorces to distinguish.**
- **Read the paper and the code of the Evaluation part. Then need to add the evaluation score of iteration 1.**
- **Finally, Need to add the improvement method with each phase. I think the structure is well to implement.**
